name: Download and Upload Voice Lines

on:
  workflow_dispatch:
  schedule:
    - cron: "0 3 * * *"

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: 📥 Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: 🐍 Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: 📦 Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests pillow

      - name: 🧰 Run script
        id: run_script
        continue-on-error: true
        run: python scripts/main.py

      - name: 🛑 Check skip
        id: skip_check
        run: |
          if [ "${{ steps.run_script.outcome }}" == "failure" ] && [ "${{ steps.run_script.conclusion }}" == "success" ]; then
            echo "should_skip=true" >> $GITHUB_OUTPUT
          elif [ "${{ steps.run_script.outcome }}" == "failure" ] && [ "${{ steps.run_script.conclusion }}" == "failure" ]; then
            echo "❌ Fatal error in script"
            exit 1
          else
            echo "should_skip=false" >> $GITHUB_OUTPUT
          fi
        shell: bash

      - name: 📝 Summary if skipped
        if: steps.skip_check.outputs.should_skip == 'true'
        run: echo "✅ No new characters or manifest changes. Skipping workflow."

      - name: 🪣 Install rclone
        if: steps.skip_check.outputs.should_skip == 'false'
        run: curl https://rclone.org/install.sh | sudo bash

      - name: ⚙️ Configure rclone
        if: steps.skip_check.outputs.should_skip == 'false'
        run: |
          mkdir -p ~/.config/rclone
          cat <<EOF > ~/.config/rclone/rclone.conf
          [r2]
          type = s3
          provider = Cloudflare
          access_key_id = ${{ secrets.R2_ACCESS_KEY_ID }}
          secret_access_key = ${{ secrets.R2_SECRET_ACCESS_KEY }}
          endpoint = ${{ secrets.R2_ENDPOINT }}
          region = auto
          EOF

      - name: ☁️ Upload voices incrementally
        if: steps.skip_check.outputs.should_skip == 'false'
        id: upload_voices
        run: |
          rclone sync voices r2:${{ secrets.R2_BUCKET_NAME }}/voices \
            --dry-run \
            --progress \
            --checkers=4 \
            --transfers=4 \
            --fast-list \
            --update \
            --size-only \
            --no-traverse

      - name: 📝 Commit new characters/icons (if any)
        if: steps.skip_check.outputs.should_skip == 'false'
        run: |
          if [[ -n "$(git status --porcelain data/json/characters data/imgs/iconCircle)" ]]; then
            git config user.name "github-actions[bot]"
            git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
            git add data/json/characters data/imgs/iconCircle
            git commit -m "🆕 Update characters and icons"
            git push
          else
            echo "No new character data to commit."
          fi

      - name: 📝 Commit manifest if voice upload succeeded
        if: steps.upload_voices.outcome == 'success'
        run: |
          if [[ -n "$(git status --porcelain data/json/manifest.json)" ]]; then
            git config user.name "github-actions[bot]"
            git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
            git add data/json/manifest.json
            git commit -m "📝 Update manifest after successful voice upload"
            git push
          else
            echo "Manifest unchanged."
          fi

      - name: ☁️ Upload manifest.json
        if: steps.upload_voices.outcome == 'success'
        run: |
          rclone copy data/json/manifest.json r2:${{ secrets.R2_BUCKET_NAME }}/data/json/
